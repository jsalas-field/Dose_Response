---
title: "Non-Linear Mixed Effects Regression Modeling" 
author: "Jonathan Salas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    df_print: kable
    fig_height: 6
    keep_md: true
---

```{r setup, include=FALSE}
library(knitr)
library(dplyr)
library(ggplot2)
library(emmeans)
library(medrc)
library(aomisc)
knitr::opts_chunk$set(echo = F)
knitr::opts_knit$set(root.dir = "~/R_Projects/Dose_Response")
```

# Start with a clean slate

```{r echo = F}
rm(list = ls(all.names = TRUE))
```

# Import the cleaned data - Point to the correct raw data directory

```{r echo = F}
working_dat_dir <-"data/processed/working_dr.RData"
```

# Aesthetics

```{r echo = F}
blank.plot <- theme_bw() +
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), #this theme section generates a blank canvas
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"),
        legend.title = element_blank(),
        legend.justification="top")
```

## Import Subject Data
```{r echo = F}
load(working_dat_dir)
```

# Regression Data

```{r}
reg_dat <- working_dat |>
  filter(pulse_seq == "20x5" & waveform == "unipolar") |>
  mutate(id = factor(id))
```


## 3-Parameter Nonlinear Logisitic Regression

We don't have enough data to accurately model the floor, so we'll only model the Slope, Upper Limit, and ED50.

b = steepness, e = ED50, d = upper limit, c = lower limit, f = asymmetry
meL.3(x, b, d, e)
meL.4(x, b, c, d, e)

### Nonlinear 3-parameter logisitic regression 

```{r}
modNaive1 <- drm(depth ~ application_num, data = reg_dat,
            fct = L.3(names = c("Slope", "Upper Limit", "ED50")))
```

```{r}
summary(modNaive1)
```

```{r}
plot(modNaive1)
```

### 3 parameter logistic mixed effects - metadrm = nlme

```{r}
me_metadrm_mod1 <- metadrm(depth ~ application_num,
              data=reg_dat,
              fct=L.3(names = c("Slope", "Upper Limit", "ED50")),
              ind=id,
              struct="UN")
```

```{r}
summary(me_metadrm_mod1)
```

```{r}
me_medrm_mod1 <- medrm(depth ~ application_num, data=reg_dat,
            random=b + d + e ~ 1|id,
            fct=L.3()
            #start=c(0.5, 2000, 0.05)
            )
```
```{r}
summary(me_medrm_mod1)
```
```{r}
plot(me_medrm_mod1)
```

# Version and Package Details

```{r echo=F}
paste(version$version.string, version$nickname)
paste0(
  "RStudio Version ",
  rstudioapi::versionInfo()$version,
  " ",
  rstudioapi::versionInfo()$release_name
) # RStudio Version
subset(data.frame(sessioninfo::package_info()),
       attached == TRUE,
       c(package, loadedversion)) # Loaded Packages
```

# When were these files last rewritten?

```{r}
date()
```